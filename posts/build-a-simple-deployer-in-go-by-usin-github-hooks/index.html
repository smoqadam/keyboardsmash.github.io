<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Build a Simple Deployer with Go by Using the Github Webhooks | Keyboard Smash</title><meta name=keywords content="go"><meta name=description content="In my journey to learn Go, I decided to start write about the topics that I&rsquo;m learning. This technique known as Feynman Learning Technique. I have done this long time ago when I wanted to learn PHP, I started a blog in Persian, and start to write about everything I was learning about PHP. These articles might not be useful for experienced programmers, but it helps me to have a deep understanding about the stuff I&rsquo;m going to learn.
In this article, I want to write a simple deployer by using Github Webhooks.
Anyway, please let me know if you find any issues or mistakes. We can disscuss about it and we can learn together."><meta name=author content="Saeed"><link rel=canonical href=https://keyboardsmash.dev/posts/build-a-simple-deployer-in-go-by-usin-github-hooks/><link href=/assets/css/stylesheet.min.8d754ccb970fef4a6d8e5b0441e01d76a0d3530c6777067a1b2ca581aa1b4af7.css integrity="sha256-jXVMy5cP70ptjlsEQeAddqDTUwxndwZ6GyylgaobSvc=" rel="preload stylesheet" as=style><link rel=icon href=https://keyboardsmash.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://keyboardsmash.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://keyboardsmash.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://keyboardsmash.dev/apple-touch-icon.png><link rel=mask-icon href=https://keyboardsmash.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.102.3"><meta property="og:title" content="Build a Simple Deployer with Go by Using the Github Webhooks"><meta property="og:description" content="In my journey to learn Go, I decided to start write about the topics that I&rsquo;m learning. This technique known as Feynman Learning Technique. I have done this long time ago when I wanted to learn PHP, I started a blog in Persian, and start to write about everything I was learning about PHP. These articles might not be useful for experienced programmers, but it helps me to have a deep understanding about the stuff I&rsquo;m going to learn.
In this article, I want to write a simple deployer by using Github Webhooks.
Anyway, please let me know if you find any issues or mistakes. We can disscuss about it and we can learn together."><meta property="og:type" content="article"><meta property="og:url" content="https://keyboardsmash.dev/posts/build-a-simple-deployer-in-go-by-usin-github-hooks/"><meta property="article:published_time" content="2020-05-11T16:58:01+08:00"><meta property="article:modified_time" content="2020-05-11T16:58:01+08:00"><meta property="og:site_name" content="Keyboard Smash"><meta name=twitter:card content="summary"><meta name=twitter:title content="Build a Simple Deployer with Go by Using the Github Webhooks"><meta name=twitter:description content="In my journey to learn Go, I decided to start write about the topics that I&rsquo;m learning. This technique known as Feynman Learning Technique. I have done this long time ago when I wanted to learn PHP, I started a blog in Persian, and start to write about everything I was learning about PHP. These articles might not be useful for experienced programmers, but it helps me to have a deep understanding about the stuff I&rsquo;m going to learn.
In this article, I want to write a simple deployer by using Github Webhooks.
Anyway, please let me know if you find any issues or mistakes. We can disscuss about it and we can learn together."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://keyboardsmash.dev/posts/"},{"@type":"ListItem","position":3,"name":"Build a Simple Deployer with Go by Using the Github Webhooks","item":"https://keyboardsmash.dev/posts/build-a-simple-deployer-in-go-by-usin-github-hooks/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Build a Simple Deployer with Go by Using the Github Webhooks","name":"Build a Simple Deployer with Go by Using the Github Webhooks","description":"In my journey to learn Go, I decided to start write about the topics that I\u0026amp;rsquo;m learning. This technique known as Feynman Learning Technique. I have done this long time ago …","keywords":["go"],"articleBody":"In my journey to learn Go, I decided to start write about the topics that I’m learning. This technique known as Feynman Learning Technique. I have done this long time ago when I wanted to learn PHP, I started a blog in Persian, and start to write about everything I was learning about PHP. These articles might not be useful for experienced programmers, but it helps me to have a deep understanding about the stuff I’m going to learn.\nIn this article, I want to write a simple deployer by using Github Webhooks.\nAnyway, please let me know if you find any issues or mistakes. We can disscuss about it and we can learn together.\nAt the end of this article, we will learn:\nHow to setup Github Webhooks How to Parse and authenticate webhooks requests How to parse YAML and JSON Run a series of command in a specific directory Prerequisites Basic knowledge of Go Go must be installed in your machine GitHub account Table of content What do we expect from this project? It’s good to know what we should expect at the end of this project. Here is a short description. We have a project in GitHub and we need a project to automate our deployment proccess whenever someone push something to the master branch. For this purpose, we are going to take advantage of GitHub webhooks which sends a request to a URL (apparantly in our sever) with a bunch of data about the changes that just made into the repository. The webhook can trigger after push, merge, pull requests and etc. For the sake of simplicity we just use push event for this tutorial.\nRead more about Webhooks\nConfigure GitHub webhooks For using Webhooks, first, we need to enable and configure it for our repository. Open your github repository page and chose the Webhooks from the left sidebar. After click on Add webhook you will see the following page:\nPayload URL: The URL we want to send the request Secret: A secret key to authorize incoming the request Which events would you like to trigger this webhook?: In this section you can chose push or another events. For this tutorial we will only go with the push event. And at the end, by selecting Active and Add Webhook this webhook will be enabled for our repository. Which means, everytime we push to the repository, GitHub will send a request to Payload URL.\nCreate a project and install needed packages Create a new directory and call it whatever you want:\n$ mkdir deployer \u0026\u0026 cd deployer The only library we need is Yaml parser because we want to store some configuration in it.\ngo get github.com/go-yaml/yaml Deployer Configuration For the sake of flixibility I decided to have a configuration in Yaml format. By this method, we can have multiple projects with different configurations. Create a config.yaml in your root directory:\nprojects: - name: \"username/project\" dir: \"/path/to/blog\" commands: - git status - git pull origin master - git submodule sync - git submodule update secret: the_secret_key Our config.yaml file is consists of a projects array, and each project can have\nname which must be the same as the name of your github username and project dir is the path of your project commands is a list of commands we need to run whenever a webhook reached our server secret is the secret key you chose in your github. Parse config.yaml Next step we are going to parse this file with helps of go-yaml/yaml package.\npackage main import ( \"io/ioutil\" \"gopkg.in/yaml.v2\" ) type Project struct { Name string `yaml:\"name\"` Dir string `yaml:\"dir\"` Commands []string `yaml:\"commands\"` OnFailure string `yaml:\"onFailure\"` } type Config struct { Projects []*Project `yaml:\"projects,omitempty\"` } func NewConfig(path string) (*Config, error) { c := \u0026Config{} y, err := ioutil.ReadFile(path) if err != nil { return c, err } yaml.Unmarshal(y, \u0026c) return c, nil } // Return a Project based on its name func (c *Config) getProject(name string) *Project { for _, p := range c.Projects { if name == p.Name { return p } } return \u0026Project{} } Thers is nothing much happened here, first we read the file and Unmarshal the content. The getProject function receives a name and return a Project instance.\nParse incoming request As soone as someone we push something to the repository, GitHub sends a request to the URL we set for webhook. The request body is contains a payload in json which we are going to parse the it here. Notice that, we only parse the information in that we need for this article, you can customize it based on your needs.\nCreate a file and call it payload.go:\npackage main import ( \"encoding/json\" ) type Author struct { Name string `json:\"name\"` Email string `json:\"email\"` Username string `json:\"username\"` } type Commit struct { ID string `json:\"id\"` // commit message Message string `json:\"message\"` // commit author Authod Author `json:\"author\"` // list of the files that added to the repo Added []string `json:\"added\"` // list of the files removed from the repo Removed []string `json:\"removed\"` // list of the files modified in the repo Modified []string `json:\"modified\"` } type Repository struct { // repository name e.g. username/repo Name string `json:\"full_name\"` } type Payload struct { // Repository name Repo Repository `json:\"repository\"` // Slice of commits Commits []Commit `json:\"commits\"` } func NewPayload(input []byte) (*Payload, error) { p := \u0026Payload{} if err := json.Unmarshal(input, \u0026p); err != nil { return p, err } return p, nil } Payload struct has two fields, Repo that store information about the repository and the Commits that store array of Commit struct.\nCreate route To handle webhooks, we need a route and we are going to use built in go http library.\nCreate main.go file with the following content:\npackage main import ( \"log\" \"net/http\" ) func main() { http.HandleFunc(\"/deploy\", deployHandler) log.Fatalln(http.ListenAndServe(\":3000\", nil)) } func deployHandler(w http.ResponseWriter, r *http.Request) { // 1. parse the payload // 2. parse config // 3. authenticate // 4. run commands } As you can see inside the deployHandler I mentioned 4 steps. Let’s complete the steps on by one.\n// Read the request body body, err := ioutil.ReadAll(r.Body) if err != nil { panic(err) } // 1. parse the payload payload, err := NewPayload(body) if err != nil { panic(err) } // 2. parse config config, err := NewConfig(\"./config.yaml\") if err != nil { panic(err) } // get the project config based on the repository name project := config.getProject(payload.Repo.Name) Most of the codes here are self explainatory, but notice how we read the request body at the first of the function.\nAuthentication In the next step we are going to authenticate the request. For this matter, we need to\nRead the X-Hub-Signature header which is a sha1 encoded hash Encode the request body with the secret key Compare number 1 and 2 in main.go add a function and call it isValidSignature:\nfunc isValidSignature(body []byte, signature string, key string) bool { gotHash := strings.SplitN(signature, \"=\", 2) if gotHash[0] != \"sha1\" { return false } hash := hmac.New(sha1.New, []byte(key)) if _, err := hash.Write(body); err != nil { log.Printf(\"Cannot compute the HMAC for request: %s\\n\", err) return false } expectedHash := hex.EncodeToString(hash.Sum(nil)) return gotHash[1] == expectedHash } isValidSignature recieves three arguments, the request body in []byte, the X-Hub-Signature header value, and the secret key. isValidSignature first checks the the hash algorithm which must be sha1, then encode the request body with the secret key, and at the end it compare the signature with the hashed value.\nLet’s add step 3 to our deployHandler:\n.... // get the project config based on repo name project := config.getProject(payload.Repo.Name) // 3. authenticate if !isValidSignature(body, r.Header.Get(\"X-Hub-Signature\"), project.secret) { w.WriteHeader(http.StatusBadRequest) w.Write([]byte(\"error\")) } else { // run the commands } Runner The main purpose of this project is to run a sequence of commands whenever a github repository get updated. We already stored these commands in config.yaml file, now, it’s time to run commands one by one and log the result.\nCreate a runner.go file and put the following code on it:\npackage main import ( \"log\" ) type Runner struct { // Commands stores a list of commands Commands []string // Dir is the path Commands must execute Dir string // Log is log the output of each command Log *log.Logger // ErrLog is log all the errors ErrLog *log.Logger } func NewRunner(commands []string, dir string) *Runner { return \u0026Runner{ Commands: commands, Dir: dir, Log: log.New(os.Stdout, \"Log: \", log.LstdFlags), ErrLog: log.New(os.Stdout, \"Error: \", log.LstdFlags), } } Runner struct is reponsible to run a sequence of commands in an specific directory. By default it logs data to Stdout, but we can write the logs into a file with something like this:\nr := NewRunner(project.commands, project.Dir) f, _ := os.OpenFile(\"runner.log\", os.O_RDWR | os.O_CREATE | os.O_APPEND, 0666) r.Log.SetOutput(f) fe, _ := os.OpenFile(\"error.log\", os.O_RDWR | os.O_CREATE | os.O_APPEND, 0666) r.ErrLog.SetOutput(fe) Now add the following functions in runner.go:\nfunc (r *Runner) run() error { for _, command := range r.Commands { if err := r.exec(command, r.Dir); err != nil { return err } } return nil } func (r *Runner) exec(command string, dir string) error { c, args := r.parse(command) cmd := exec.Command(c, args...) cmd.Dir = dir output, err := cmd.Output() if err != nil { r.ErrLog.Println(c, err) return err } r.Log.Println(string(output)) return nil } func (r *Runner) parse(cmd string) (string, []string) { c := strings.Split(cmd, \" \") return c[0], c[1:] } os/exec package is responsible to run a system command. The first argument for Command function is the command we want to run, and the second parameter is a slice of string which is the command’s parameters.\nBased on our config.yaml’s commands section, the commands has written in one line that we need to take the first part as an actual command and the rest of it must consider as the command’s parameters. We have done this in parse function. exec function is responsible for executing a command in the given directory, and finally, the run command will run all the commands we have sent to the Runner constructor.\nNow it’s time to finish our deployHandler function. Open main.go and add the last step to the deployHandler function:\nfunc deployHandler(w http.ResponseWriter, r *http.Request) { // 1. parse the payload ... // 2. parse config ... // 3. authenticate if !isValidSignature(body, r.Header.Get(\"X-Hub-Signature\"), project.secret) { w.WriteHeader(http.StatusBadRequest) w.Write([]byte(\"error\")) } else { // 4. run commands runner := NewRunner(project.Commands, project.Dir) if err := runner.run(); err != nil { w.WriteHeader(http.StatusBadRequest) w.Write([]byte(\"error\")) } else { w.WriteHeader(http.StatusOK) w.Write([]byte(\"success\")) } } runner.run() runs commands one by one and return error in each step the running command failed.\nOur deployer is working now. But there are many things can be added to it.\n","wordCount":"1780","inLanguage":"en","datePublished":"2020-05-11T16:58:01+08:00","dateModified":"2020-05-11T16:58:01+08:00","author":{"@type":"Person","name":"Saeed"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://keyboardsmash.dev/posts/build-a-simple-deployer-in-go-by-usin-github-hooks/"},"publisher":{"@type":"Organization","name":"Keyboard Smash","logo":{"@type":"ImageObject","url":"https://keyboardsmash.dev/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://keyboardsmash.dev accesskey=h title="Keyboard Smash (Alt + H)">Keyboard Smash</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://keyboardsmash.dev/pages/about title=About><span>About</span></a></li><li><a href=https://keyboardsmash.dev/categories/ title=Categories><span>Categories</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Build a Simple Deployer with Go by Using the Github Webhooks</h1><div class=post-meta>May 11, 2020&nbsp;·&nbsp;9 min&nbsp;·&nbsp;Saeed</div></header><div class=post-content><p>In my journey to learn Go, I decided to start write about the topics that I&rsquo;m learning. This technique known as Feynman Learning Technique. I have done this long time ago when I wanted to learn PHP, I started a blog in Persian, and start to write about everything I was learning about PHP. These articles might not be useful for experienced programmers, but it helps me to have a deep understanding about the stuff I&rsquo;m going to learn.</p><p>In this article, I want to write a simple deployer by using Github Webhooks.</p><p>Anyway, please let me know if you find any issues or mistakes. We can disscuss about it and we can learn together.</p><p>At the end of this article, we will learn:</p><ul><li>How to setup Github Webhooks</li><li>How to Parse and authenticate webhooks requests</li><li>How to parse YAML and JSON</li><li>Run a series of command in a specific directory</li></ul><h3 id=prerequisites>Prerequisites<a hidden class=anchor aria-hidden=true href=#prerequisites>#</a></h3><ul><li>Basic knowledge of Go</li><li>Go must be installed in your machine</li><li>GitHub account</li></ul><h2 id=table-of-content>Table of content<a hidden class=anchor aria-hidden=true href=#table-of-content>#</a></h2><h2 id=what-do-we-expect-from-this-project>What do we expect from this project?<a hidden class=anchor aria-hidden=true href=#what-do-we-expect-from-this-project>#</a></h2><p>It&rsquo;s good to know what we should expect at the end of this project. Here is a short description.
We have a project in GitHub and we need a project to automate our deployment proccess whenever someone <strong>push</strong> something to the master branch. For this purpose, we are going to take advantage of GitHub webhooks which sends a request to a URL (apparantly in our sever) with a bunch of data about the changes that just made into the repository. The webhook can trigger after <code>push</code>, <code>merge</code>, <code>pull requests</code> and etc. For the sake of simplicity we just use <code>push</code> event for this tutorial.</p><p><a href=https://developer.github.com/webhooks/>Read more about Webhooks</a></p><h2 id=configure-github-webhooks>Configure GitHub webhooks<a hidden class=anchor aria-hidden=true href=#configure-github-webhooks>#</a></h2><p>For using Webhooks, first, we need to enable and configure it for our repository. Open your github repository page and chose the Webhooks from the left sidebar. After click on Add webhook you will see the following page:</p><ul><li>Payload URL: The URL we want to send the request</li><li>Secret: A secret key to authorize incoming the request</li><li>Which events would you like to trigger this webhook?: In this section you can chose <code>push</code> or another events. For this tutorial we will only go with the <code>push</code> event.</li></ul><p>And at the end, by selecting <code>Active</code> and <code>Add Webhook</code> this webhook will be enabled for our repository. Which means, everytime we <code>push</code> to the repository, GitHub will send a request to Payload URL.</p><h2 id=create-a-project-and-install-needed-packages>Create a project and install needed packages<a hidden class=anchor aria-hidden=true href=#create-a-project-and-install-needed-packages>#</a></h2><p>Create a new directory and call it whatever you want:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ mkdir deployer <span style=color:#f92672>&amp;&amp;</span> cd deployer
</span></span></code></pre></div><p>The only library we need is Yaml parser because we want to store some configuration in it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go get github.com/go-yaml/yaml
</span></span></code></pre></div><h2 id=deployer-configuration>Deployer Configuration<a hidden class=anchor aria-hidden=true href=#deployer-configuration>#</a></h2><p>For the sake of flixibility I decided to have a configuration in Yaml format. By this method, we can have multiple projects with different configurations. Create a <code>config.yaml</code> in your root directory:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>projects</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;username/project&#34;</span> 
</span></span><span style=display:flex><span>      <span style=color:#f92672>dir</span>: <span style=color:#e6db74>&#34;/path/to/blog&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>commands</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>git status</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>git pull origin master</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>git submodule sync</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>git submodule update</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>secret</span>: <span style=color:#ae81ff>the_secret_key</span>
</span></span></code></pre></div><p>Our <code>config.yaml</code> file is consists of a <code>projects</code> array, and each project can have</p><ul><li><code>name</code> which must be the same as the name of your github username and project</li><li><code>dir</code> is the path of your project</li><li><code>commands</code> is a list of commands we need to run whenever a webhook reached our server</li><li><code>secret</code> is the secret key you chose in your github.</li></ul><h3 id=parse-configyaml>Parse config.yaml<a hidden class=anchor aria-hidden=true href=#parse-configyaml>#</a></h3><p>Next step we are going to parse this file with helps of go-yaml/yaml package.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;io/ioutil&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;gopkg.in/yaml.v2&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Project</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Name</span>      <span style=color:#66d9ef>string</span>   <span style=color:#e6db74>`yaml:&#34;name&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Dir</span>       <span style=color:#66d9ef>string</span>   <span style=color:#e6db74>`yaml:&#34;dir&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Commands</span>  []<span style=color:#66d9ef>string</span> <span style=color:#e6db74>`yaml:&#34;commands&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>OnFailure</span> <span style=color:#66d9ef>string</span>   <span style=color:#e6db74>`yaml:&#34;onFailure&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Config</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Projects</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>Project</span> <span style=color:#e6db74>`yaml:&#34;projects,omitempty&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewConfig</span>(<span style=color:#a6e22e>path</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>Config</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Config</span>{}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>y</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadFile</span>(<span style=color:#a6e22e>path</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>yaml</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>y</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Return a Project based on its name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Config</span>) <span style=color:#a6e22e>getProject</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Project</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Projects</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>name</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Name</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>p</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Project</span>{}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Thers is nothing much happened here, first we read the file and <code>Unmarshal</code> the content. The <code>getProject</code> function receives a name and return a <code>Project</code> instance.</p><h2 id=parse-incoming-request>Parse incoming request<a hidden class=anchor aria-hidden=true href=#parse-incoming-request>#</a></h2><p>As soone as someone we <code>push</code> something to the repository, GitHub sends a request to the URL we set for webhook. The request body is contains a <code>payload</code> in <code>json</code> which we are going to parse the it here. Notice that, we only parse the information in that we need for this article, you can customize it based on your needs.</p><p>Create a file and call it <code>payload.go</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;encoding/json&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Author</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Name</span>     <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;name&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Email</span>    <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;email&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Username</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;username&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Commit</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ID</span>       <span style=color:#66d9ef>string</span>   <span style=color:#e6db74>`json:&#34;id&#34;`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// commit message
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Message</span>  <span style=color:#66d9ef>string</span>   <span style=color:#e6db74>`json:&#34;message&#34;`</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// commit author
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>Authod</span>   <span style=color:#a6e22e>Author</span>   <span style=color:#e6db74>`json:&#34;author&#34;`</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// list of the files that added to the repo
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>Added</span>    []<span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;added&#34;`</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// list of the files removed from the repo
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>Removed</span>  []<span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;removed&#34;`</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// list of the files modified in the repo
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Modified</span> []<span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;modified&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Repository</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// repository name e.g. username/repo 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Name</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;full_name&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Payload</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Repository name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Repo</span>    <span style=color:#a6e22e>Repository</span> <span style=color:#e6db74>`json:&#34;repository&#34;`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Slice of commits
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Commits</span> []<span style=color:#a6e22e>Commit</span>   <span style=color:#e6db74>`json:&#34;commits&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewPayload</span>(<span style=color:#a6e22e>input</span> []<span style=color:#66d9ef>byte</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>Payload</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Payload</span>{}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>input</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>p</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>p</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>Payload</code> struct has two fields, <code>Repo</code> that store information about the repository and the <code>Commits</code> that store array of <code>Commit</code> struct.</p><h2 id=create-route>Create route<a hidden class=anchor aria-hidden=true href=#create-route>#</a></h2><p>To handle webhooks, we need a route and we are going to use built in go <code>http</code> library.</p><p>Create <code>main.go</code> file with the following content:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/deploy&#34;</span>, <span style=color:#a6e22e>deployHandler</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalln</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;:3000&#34;</span>, <span style=color:#66d9ef>nil</span>))
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>deployHandler</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 1. parse the payload
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 2. parse config
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 3. authenticate
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 4. run commands
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>As you can see inside the <code>deployHandler</code> I mentioned 4 steps. Let&rsquo;s complete the steps on by one.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#75715e>// Read the request body
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>body</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 1. parse the payload
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>payload</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewPayload</span>(<span style=color:#a6e22e>body</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 2. parse config
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>config</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewConfig</span>(<span style=color:#e6db74>&#34;./config.yaml&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// get the project config based on the repository name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>project</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>getProject</span>(<span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Repo</span>.<span style=color:#a6e22e>Name</span>)
</span></span></code></pre></div><p>Most of the codes here are self explainatory, but notice how we read the request body at the first of the function.</p><h3 id=authentication>Authentication<a hidden class=anchor aria-hidden=true href=#authentication>#</a></h3><p>In the next step we are going to authenticate the request. For this matter, we need to</p><ol><li>Read the <code>X-Hub-Signature</code> header which is a <code>sha1</code> encoded hash</li><li>Encode the request body with the secret key</li><li>Compare number 1 and 2</li></ol><p>in <code>main.go</code> add a function and call it <code>isValidSignature</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>isValidSignature</span>(<span style=color:#a6e22e>body</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>signature</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gotHash</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>SplitN</span>(<span style=color:#a6e22e>signature</span>, <span style=color:#e6db74>&#34;=&#34;</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>gotHash</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;sha1&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>hash</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>hmac</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>sha1</span>.<span style=color:#a6e22e>New</span>, []byte(<span style=color:#a6e22e>key</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>hash</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>body</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Cannot compute the HMAC for request: %s\n&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>expectedHash</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>hex</span>.<span style=color:#a6e22e>EncodeToString</span>(<span style=color:#a6e22e>hash</span>.<span style=color:#a6e22e>Sum</span>(<span style=color:#66d9ef>nil</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>gotHash</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#a6e22e>expectedHash</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>isValidSignature</code> recieves three arguments, the request body in <code>[]byte</code>, the <code>X-Hub-Signature</code> header value, and the secret key. <code>isValidSignature</code> first checks the the hash algorithm which must be <code>sha1</code>, then encode the request body with the secret key, and at the end it compare the signature with the hashed value.</p><p>Let&rsquo;s add step 3 to our <code>deployHandler</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#f92672>...</span>.
</span></span><span style=display:flex><span>	<span style=color:#75715e>// get the project config based on repo name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>project</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>getProject</span>(<span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Repo</span>.<span style=color:#a6e22e>Name</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 3. authenticate
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>isValidSignature</span>(<span style=color:#a6e22e>body</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;X-Hub-Signature&#34;</span>), <span style=color:#a6e22e>project</span>.<span style=color:#a6e22e>secret</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Write</span>([]byte(<span style=color:#e6db74>&#34;error&#34;</span>))
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// run the commands
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}
</span></span></code></pre></div><h3 id=runner>Runner<a hidden class=anchor aria-hidden=true href=#runner>#</a></h3><p>The main purpose of this project is to run a sequence of commands whenever a github repository get updated. We already stored these commands in <code>config.yaml</code> file, now, it&rsquo;s time to run commands one by one and log the result.</p><p>Create a <code>runner.go</code> file and put the following code on it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Runner</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Commands stores a list of commands 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Commands</span> []<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Dir is the path Commands must execute
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Dir</span>      <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Log is log the output of each command
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Log</span>      <span style=color:#f92672>*</span><span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Logger</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ErrLog is log all the errors
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ErrLog</span>   <span style=color:#f92672>*</span><span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Logger</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewRunner</span>(<span style=color:#a6e22e>commands</span> []<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>dir</span> <span style=color:#66d9ef>string</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Runner</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Runner</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Commands</span>: <span style=color:#a6e22e>commands</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Dir</span>:      <span style=color:#a6e22e>dir</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Log</span>:      <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stdout</span>, <span style=color:#e6db74>&#34;Log: &#34;</span>, <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>LstdFlags</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ErrLog</span>:   <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stdout</span>, <span style=color:#e6db74>&#34;Error: &#34;</span>, <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>LstdFlags</span>),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>Runner</code> struct is reponsible to run a sequence of commands in an specific directory. By default it logs data to Stdout, but we can write the logs into a file with something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewRunner</span>(<span style=color:#a6e22e>project</span>.<span style=color:#a6e22e>commands</span>, <span style=color:#a6e22e>project</span>.<span style=color:#a6e22e>Dir</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>OpenFile</span>(<span style=color:#e6db74>&#34;runner.log&#34;</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>O_RDWR</span> | <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>O_CREATE</span> | <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>O_APPEND</span>, <span style=color:#ae81ff>0666</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Log</span>.<span style=color:#a6e22e>SetOutput</span>(<span style=color:#a6e22e>f</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fe</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>OpenFile</span>(<span style=color:#e6db74>&#34;error.log&#34;</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>O_RDWR</span> | <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>O_CREATE</span> | <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>O_APPEND</span>, <span style=color:#ae81ff>0666</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>ErrLog</span>.<span style=color:#a6e22e>SetOutput</span>(<span style=color:#a6e22e>fe</span>)
</span></span></code></pre></div><p>Now add the following functions in <code>runner.go</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Runner</span>) <span style=color:#a6e22e>run</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>command</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Commands</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>exec</span>(<span style=color:#a6e22e>command</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Dir</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Runner</span>) <span style=color:#a6e22e>exec</span>(<span style=color:#a6e22e>command</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>dir</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>args</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>command</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cmd</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>exec</span>.<span style=color:#a6e22e>Command</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>args</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>Dir</span> = <span style=color:#a6e22e>dir</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>output</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>Output</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>ErrLog</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Log</span>.<span style=color:#a6e22e>Println</span>(string(<span style=color:#a6e22e>output</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Runner</span>) <span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>cmd</span> <span style=color:#66d9ef>string</span>) (<span style=color:#66d9ef>string</span>, []<span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Split</span>(<span style=color:#a6e22e>cmd</span>, <span style=color:#e6db74>&#34; &#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>[<span style=color:#ae81ff>0</span>], <span style=color:#a6e22e>c</span>[<span style=color:#ae81ff>1</span>:]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>os/exec</code> package is responsible to run a system command. The first argument for <code>Command</code> function is the command we want to run, and the second parameter is a slice of string which is the command&rsquo;s parameters.</p><p>Based on our <code>config.yaml</code>&rsquo;s <code>commands</code> section, the commands has written in one line that we need to take the first part as an actual command and the rest of it must consider as the command&rsquo;s parameters. We have done this in <code>parse</code> function. <code>exec</code> function is responsible for executing a command in the given directory, and finally, the <code>run</code> command will run all the commands we have sent to the <code>Runner</code> constructor.</p><p>Now it&rsquo;s time to finish our <code>deployHandler</code> function. Open <code>main.go</code> and add the last step to the <code>deployHandler</code> function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>deployHandler</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 1. parse the payload
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 2. parse config
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#f92672>...</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 3. authenticate
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>isValidSignature</span>(<span style=color:#a6e22e>body</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;X-Hub-Signature&#34;</span>), <span style=color:#a6e22e>project</span>.<span style=color:#a6e22e>secret</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Write</span>([]byte(<span style=color:#e6db74>&#34;error&#34;</span>))
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 4. run commands
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>runner</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewRunner</span>(<span style=color:#a6e22e>project</span>.<span style=color:#a6e22e>Commands</span>, <span style=color:#a6e22e>project</span>.<span style=color:#a6e22e>Dir</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>runner</span>.<span style=color:#a6e22e>run</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Write</span>([]byte(<span style=color:#e6db74>&#34;error&#34;</span>))
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Write</span>([]byte(<span style=color:#e6db74>&#34;success&#34;</span>))
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p><code>runner.run()</code> runs commands one by one and return error in each step the running command failed.</p><p>Our deployer is working now. But there are many things can be added to it.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://keyboardsmash.dev/tags/go/>go</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://keyboardsmash.dev>Keyboard Smash</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script defer src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<script>window.onload=function(){localStorage.getItem("menu-scroll-position")&&(document.getElementById("menu").scrollLeft=localStorage.getItem("menu-scroll-position"))},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})});var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById("menu").scrollLeft)}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>