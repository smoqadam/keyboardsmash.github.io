<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Simple auto deployer with PHP | Saeed's Blog</title><meta name=keywords content><meta name=description content="How you deploy your projects? Are you using fancy things like Jenkins with lots of features and configuration that you don&rsquo;t even know about? For one of my personal projects, I needed to have a deployment tools. I tried to install and configure Jenkins but there was no chance to make it up and running. So I decided to write my own, simple deployer with PHP.
Git Hooks For this article we are using Git hooks."><meta name=author content="Saeed"><link rel=canonical href=https://keyboardsmash.dev/posts/simple-auto-deployer-with-php/><link crossorigin=anonymous href=/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe+FVUFzPh7U=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://keyboardsmash.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://keyboardsmash.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://keyboardsmash.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://keyboardsmash.dev/apple-touch-icon.png><link rel=mask-icon href=https://keyboardsmash.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-PD18QTF1JJ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PD18QTF1JJ",{anonymize_ip:!1})}</script><meta property="og:title" content="Simple auto deployer with PHP"><meta property="og:description" content="How you deploy your projects? Are you using fancy things like Jenkins with lots of features and configuration that you don&rsquo;t even know about? For one of my personal projects, I needed to have a deployment tools. I tried to install and configure Jenkins but there was no chance to make it up and running. So I decided to write my own, simple deployer with PHP.
Git Hooks For this article we are using Git hooks."><meta property="og:type" content="article"><meta property="og:url" content="https://keyboardsmash.dev/posts/simple-auto-deployer-with-php/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-12-15T16:16:50+00:00"><meta property="article:modified_time" content="2018-12-15T16:16:50+00:00"><meta property="og:site_name" content="Saeed's blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Simple auto deployer with PHP"><meta name=twitter:description content="How you deploy your projects? Are you using fancy things like Jenkins with lots of features and configuration that you don&rsquo;t even know about? For one of my personal projects, I needed to have a deployment tools. I tried to install and configure Jenkins but there was no chance to make it up and running. So I decided to write my own, simple deployer with PHP.
Git Hooks For this article we are using Git hooks."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://keyboardsmash.dev/posts/"},{"@type":"ListItem","position":3,"name":"Simple auto deployer with PHP","item":"https://keyboardsmash.dev/posts/simple-auto-deployer-with-php/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Simple auto deployer with PHP","name":"Simple auto deployer with PHP","description":"How you deploy your projects? Are you using fancy things like Jenkins with lots of features and configuration that you don\u0026rsquo;t even know about? For one of my personal projects, I needed to have a deployment tools. I tried to install and configure Jenkins but there was no chance to make it up and running. So I decided to write my own, simple deployer with PHP.\nGit Hooks For this article we are using Git hooks.","keywords":[],"articleBody":"How you deploy your projects? Are you using fancy things like Jenkins with lots of features and configuration that you don’t even know about? For one of my personal projects, I needed to have a deployment tools. I tried to install and configure Jenkins but there was no chance to make it up and running. So I decided to write my own, simple deployer with PHP.\nGit Hooks For this article we are using Git hooks. Git hooks are a script that Git runs before or after some events are triggered such as: commit, push, merge, creating a branch and so on. Although the equivalent of Git Hooks in web-based Git platforms such as Github, Gitlab or bitbucket are Webhooks, which instead of running a script, call a URL (usually in your server).\nconfigure webhooks first of all, we need to configure our repository to use webhooks. For this purpose, go to your repository settings and you will find Webhooks on the sidebar.\nAfter clicking on Add webhook button you will see the webhook settings page:\nPayload URL: the URL you want to send a POST request after or before an event\nContent Type: specify how you want to receive data from GitHub\nSecret: a secret key used for authorization\nWhich events would you like to trigger this webhook?:\nJust the push event: This option just send event name to the callback URL Send me everything: send everything to callback URL included repository and user information Let me select individual events: By choosing this option you are able to specify which events do you want to follow For this article, we stick to the first option. You can play with other options when you get familiar with the whole process.\nDeployer In the previouse step we set the push event for our webhook. It means as soon as we push something to the repository, the following http request is sent to the payload url:\nRequest URL: http://mydomain.com/deployer.php Request method: POST content-type: application/x-www-form-urlencoded Expect: User-Agent: GitHub-Hookshot/233462e X-GitHub-Delivery: ff42fb42-0107-11e9-961e-9dc5ae0da8b1 X-GitHub-Event: push X-Hub-Signature: sha1=81407666112671798a83c608efa69d1052987fe9 As you can see, there are three custom headers which are set by Github. For authorization, we must use X-Hub-Signature header. The value of X-Hub-Signature header is consists of a hash algorithm and a hash string.\nCreate a file called deployer.php and put the following content on it:\n\u003c?php $secret = 'MYSECRETKEY'; if (!isset($_SERVER['HTTP_X_HUB_SIGNATURE'])) { exit(\"Permision denied!\"); } Variable $secret is the secret key you had choosen in webhook settings. We need to compare value of HTTP_X_HUB_SIGNATURE header with sha1 value of POST request content. For this we used the following code:\n$githubHeader = $_SERVER['HTTP_X_HUB_SIGNATURE']; $rawPost = file_get_contents(\"php://input\"); $secret = str_replace(\"sha1=\", \"\", $githubHeader); $hash = hash_hmac('sha1', $rawPost, $mySecret); if ($hash != $secret){ exit (\"Permission denied!\"); } First, we remove sha1= string from the header value then hash the post content to hash with the sha1 algorithm, then we compare the values.\n$workTree = 'PROJECT_PATH'; $gitRoot = $workTree. '/.git'; $commands = array( 'pull', 'status', 'submodule sync', 'submodule update', 'submodule status', ); $log = []; $log[] = \"####### \". date('Y-m-d H:i:s') .\" #######\"; foreach($commands as $cmd) { $cmd = 'git --git-dir '.$gitRoot.' --work-tree '. $workDir . ' '. $cmd $tmp = shell_exec(\"$cmd 2\u003e\u00261\"); $log[] = \"\\$ $cmd\\n\".trim($tmp).\"\\n\"; } $log = implode(\"\\n\", $log); file_put_contents ('deployer.log', $log, FILE_APPEND); exit('success'); $workTree value must point to our project directory. As soon as we push new changes to Git repository, GitHub sends a POST request to payload URL and above script will be run. After authentication, git pull and git status commands run and the output will be stored in deployer.log file.\n","wordCount":"596","inLanguage":"en","datePublished":"2018-12-15T16:16:50Z","dateModified":"2018-12-15T16:16:50Z","author":{"@type":"Person","name":"Saeed"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://keyboardsmash.dev/posts/simple-auto-deployer-with-php/"},"publisher":{"@type":"Organization","name":"Saeed's Blog","logo":{"@type":"ImageObject","url":"https://keyboardsmash.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://keyboardsmash.dev accesskey=h title="Saeed's Blog (Alt + H)">Saeed's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://keyboardsmash.dev/about title=About><span>About</span></a></li><li><a href=https://keyboardsmash.dev/categories/ title=Categories><span>Categories</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Simple auto deployer with PHP</h1><div class=post-meta><span title='2018-12-15 16:16:50 +0000 UTC'>December 15, 2018</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;Saeed</div></header><div class=post-content><p>How you deploy your projects? Are you using fancy things like Jenkins with lots of features and configuration that you don&rsquo;t even know about? For one of my personal projects, I needed to have a deployment tools. I tried to install and configure Jenkins but there was no chance to make it up and running. So I decided to write my own, simple deployer with PHP.</p><h3 id=git-hooks>Git Hooks<a hidden class=anchor aria-hidden=true href=#git-hooks>#</a></h3><p>For this article we are using Git hooks. Git hooks are a script that Git runs before or after some events are triggered such as: commit, push, merge, creating a branch and so on. Although the equivalent of Git Hooks in web-based Git platforms such as Github, Gitlab or bitbucket are Webhooks, which instead of running a script, call a URL (usually in your server).</p><h3 id=configure-webhooks>configure webhooks<a hidden class=anchor aria-hidden=true href=#configure-webhooks>#</a></h3><p>first of all, we need to configure our repository to use webhooks. For this purpose, go to your repository settings and you will find <code>Webhooks</code> on the sidebar.</p><p><img loading=lazy src=/github-settings.png alt></p><p>After clicking on <code>Add webhook</code> button you will see the webhook settings page:</p><p><img loading=lazy src=/webhook-settings.png alt></p><p><strong>Payload URL</strong>: the URL you want to send a POST request after or before an event</p><p><strong>Content Type</strong>: specify how you want to receive data from GitHub</p><p><strong>Secret</strong>: a secret key used for authorization</p><p><strong>Which events would you like to trigger this webhook?</strong>:</p><ul><li><strong>Just the push event</strong>: This option just send event name to the callback URL</li><li><strong>Send me everything</strong>: send everything to callback URL included repository and user information</li><li><strong>Let me select individual events</strong>: By choosing this option you are able to specify which events do you want to follow</li></ul><p>For this article, we stick to the first option. You can play with other options when you get familiar with the whole process.</p><h3 id=deployer>Deployer<a hidden class=anchor aria-hidden=true href=#deployer>#</a></h3><p>In the previouse step we set the push event for our webhook. It means as soon as we push something to the repository, the following http request is sent to the payload url:</p><pre tabindex=0><code>Request URL: http://mydomain.com/deployer.php
Request method: POST
content-type: application/x-www-form-urlencoded
Expect: 
User-Agent: GitHub-Hookshot/233462e
X-GitHub-Delivery: ff42fb42-0107-11e9-961e-9dc5ae0da8b1
X-GitHub-Event: push
X-Hub-Signature: sha1=81407666112671798a83c608efa69d1052987fe9
</code></pre><p>As you can see, there are three custom headers which are set by Github. For authorization, we must use
<code>X-Hub-Signature</code> header. The value of <code>X-Hub-Signature</code> header is consists of a hash algorithm and a hash string.</p><p>Create a file called <code>deployer.php</code> and put the following content on it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$secret <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;MYSECRETKEY&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>isset</span>($_SERVER[<span style=color:#e6db74>&#39;HTTP_X_HUB_SIGNATURE&#39;</span>])) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>exit</span>(<span style=color:#e6db74>&#34;Permision denied!&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Variable <strong>$secret</strong> is the secret key you had choosen in webhook settings. We need to compare value of <code>HTTP_X_HUB_SIGNATURE</code> header with <code>sha1</code> value of POST request content. For this we used the following code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$githubHeader <span style=color:#f92672>=</span> $_SERVER[<span style=color:#e6db74>&#39;HTTP_X_HUB_SIGNATURE&#39;</span>]; 
</span></span><span style=display:flex><span>$rawPost <span style=color:#f92672>=</span> <span style=color:#a6e22e>file_get_contents</span>(<span style=color:#e6db74>&#34;php://input&#34;</span>);
</span></span><span style=display:flex><span>$secret <span style=color:#f92672>=</span> <span style=color:#a6e22e>str_replace</span>(<span style=color:#e6db74>&#34;sha1=&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>, $githubHeader);
</span></span><span style=display:flex><span>$hash <span style=color:#f92672>=</span> <span style=color:#a6e22e>hash_hmac</span>(<span style=color:#e6db74>&#39;sha1&#39;</span>, $rawPost, $mySecret);
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> ($hash <span style=color:#f92672>!=</span> $secret){
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>exit</span> (<span style=color:#e6db74>&#34;Permission denied!&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>First, we remove <code>sha1=</code> string from the header value then hash the post content to hash with the <code>sha1</code> algorithm, then we compare the values.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$workTree <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;PROJECT_PATH&#39;</span>;
</span></span><span style=display:flex><span>$gitRoot <span style=color:#f92672>=</span> $workTree<span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;/.git&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$commands <span style=color:#f92672>=</span> <span style=color:#66d9ef>array</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;pull&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;status&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;submodule sync&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;submodule update&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;submodule status&#39;</span>,
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$log <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>$log[] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;####### &#34;</span><span style=color:#f92672>.</span> <span style=color:#a6e22e>date</span>(<span style=color:#e6db74>&#39;Y-m-d H:i:s&#39;</span>) <span style=color:#f92672>.</span><span style=color:#e6db74>&#34; #######&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>foreach</span>($commands <span style=color:#66d9ef>as</span> $cmd) {
</span></span><span style=display:flex><span>    $cmd <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;git --git-dir &#39;</span><span style=color:#f92672>.</span>$gitRoot<span style=color:#f92672>.</span><span style=color:#e6db74>&#39; --work-tree &#39;</span><span style=color:#f92672>.</span> $workDir <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39; &#39;</span><span style=color:#f92672>.</span> $cmd
</span></span><span style=display:flex><span>    $tmp <span style=color:#f92672>=</span> <span style=color:#a6e22e>shell_exec</span>(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$cmd</span><span style=color:#e6db74> 2&gt;&amp;1&#34;</span>);
</span></span><span style=display:flex><span>    $log[] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\$</span><span style=color:#e6db74> </span><span style=color:#e6db74>$cmd\n</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span>($tmp)<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>$log <span style=color:#f92672>=</span> <span style=color:#a6e22e>implode</span>(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, $log);
</span></span><span style=display:flex><span><span style=color:#a6e22e>file_put_contents</span> (<span style=color:#e6db74>&#39;deployer.log&#39;</span>, $log, <span style=color:#a6e22e>FILE_APPEND</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>exit</span>(<span style=color:#e6db74>&#39;success&#39;</span>);
</span></span></code></pre></div><p><strong>$workTree</strong> value must point to our project directory. As soon as we push new changes to Git repository, GitHub sends a POST request to payload URL and above script will be run. After authentication, <strong>git pull</strong> and <strong>git status</strong> commands run and the output will be stored in <em>deployer.log</em> file.</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://keyboardsmash.dev>Saeed's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>